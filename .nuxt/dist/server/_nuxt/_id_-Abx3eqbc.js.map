{"version":3,"file":"_id_-Abx3eqbc.js","sources":["../../../../pages/admin/news/edit/[id].vue"],"sourcesContent":["<template>\n    <section class=\"breadcrumb__area include-bg pb-40 pt-30 grey-bg-4\">\n        <div class=\"container\">\n            <div class=\"row\">\n                <div class=\"col-xxl-12\">\n                    <div class=\"breadcrumb__content p-relative z-index-1\">\n                        <div class=\"breadcrumb__list\">\n                            <span> จัดการข้อมูล </span>\n                            <span class=\"dvdr\"\n                                ><i class=\"fa-solid fa-circle-small\"></i\n                            ></span>\n                            <span>\n                                <NuxtLink href=\"/admin/news\">\n                                    รายการข่าว\n                                </NuxtLink></span\n                            >\n                            <span class=\"dvdr\"\n                                ><i class=\"fa-solid fa-circle-small\"></i\n                            ></span>\n                            <span> แก้ไขข้อมูล </span>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </section>\n\n    <section class=\"portfolio__area pt-40 pb-40\">\n        <div class=\"container\">\n            <div class=\"row\">\n                <div class=\"col-12\">\n                    <h4>แบบฟอร์มแก้ไขข้อมูลข่าว</h4>\n                </div>\n                <div class=\"col-12\">\n                    <div class=\"\">\n                        <div class=\"\">\n                            <div class=\"form-group row mt-10\">\n                                <label for=\"\" class=\"label label-required\"\n                                    >หน่วยงาน :\n                                </label>\n                                <div>\n                                    <client-only>\n                                        <v-select\n                                            label=\"title\"\n                                            placeholder=\"หน่วยงาน\"\n                                            :options=\"selectOptions.departments\"\n                                            v-model=\"item.department_id\"\n                                            class=\"v-select-no-border\"\n                                            :clearable=\"true\"\n                                        ></v-select>\n                                    </client-only>\n                                </div>\n                            </div>\n\n                            <div class=\"form-group row mt-10\">\n                                <label for=\"\" class=\"label label-required\"\n                                    >ประเภทข่าว :\n                                </label>\n                                <div>\n                                    <client-only>\n                                        <v-select\n                                            label=\"title\"\n                                            placeholder=\"ประเภทข่าว\"\n                                            :options=\"selectOptions.news_types\"\n                                            v-model=\"item.news_type_id\"\n                                            class=\"v-select-no-border\"\n                                            :clearable=\"true\"\n                                        ></v-select>\n                                    </client-only>\n                                </div>\n                            </div>\n\n                            <div class=\"form-group row mt-10\">\n                                <label for=\"\" class=\"label label-required\"\n                                    >ประเภทการบริการวิชาการ :\n                                </label>\n                                <div>\n                                    <client-only>\n                                        <v-select\n                                            label=\"title\"\n                                            placeholder=\"ประเภทการบริการวิชาการ\"\n                                            :options=\"\n                                                selectOptions.service_categories\n                                            \"\n                                            v-model=\"item.service_category_id\"\n                                            multiple\n                                            class=\"v-select-no-border\"\n                                            :clearable=\"true\"\n                                        ></v-select>\n                                    </client-only>\n                                </div>\n                            </div>\n\n                            <div class=\"form-group row mt-10\">\n                                <label for=\"\" class=\"label label-required\"\n                                    >รูปภาพปก :\n                                </label>\n                                <div class=\"col-sm-10\">\n                                    <input\n                                        ref=\"file\"\n                                        class=\"form-control\"\n                                        type=\"file\"\n                                        id=\"formFile\"\n                                    />\n                                </div>\n                                <div class=\"col-sm-2\">\n                                    <a\n                                        :href=\"item.news_file_old\"\n                                        target=\"_blank\"\n                                        class=\"btn btn-primary\"\n                                        style=\"width: 100%\"\n                                    >\n                                        View Old File\n                                    </a>\n                                </div>\n                            </div>\n\n                            <div class=\"form-group row mt-10\">\n                                <label for=\"\" class=\"label label-required\"\n                                    >หัวข้อ :\n                                </label>\n                                <div>\n                                    <input\n                                        type=\"text\"\n                                        class=\"form-control form-control-plaintext\"\n                                        v-model=\"item.title_th\"\n                                    />\n                                </div>\n                            </div>\n\n                            <div class=\"form-group row mt-10\">\n                                <label for=\"\" class=\"label label-required\"\n                                    >เนื้อหาข่าว :\n                                </label>\n                                <div>\n                                    <client-only>\n                                        <froala\n                                            tag=\"textarea\"\n                                            :config=\"config.detail_th\"\n                                            v-model=\"item.detail_th\"\n                                        ></froala>\n\n                                        <div id=\"detail-th\"></div>\n                                    </client-only>\n                                </div>\n                            </div>\n\n                            <div class=\"form-group row mt-10\">\n                                <label for=\"\" class=\"label label-required\"\n                                    >วันที่ลงข้อมูล :\n                                </label>\n                                <div>\n                                    <VueDatePicker\n                                        v-model=\"item.created_news\"\n                                        :enable-time-picker=\"false\"\n                                        locale=\"th\"\n                                        auto-apply\n                                        :format=\"format\"\n                                    >\n                                        <template\n                                            #year-overlay-value=\"{ text }\"\n                                        >\n                                            {{ parseInt(text) + 543 }}\n                                        </template>\n                                        <template #year=\"{ year }\">\n                                            {{ year + 543 }}\n                                        </template>\n                                    </VueDatePicker>\n                                </div>\n                            </div>\n\n                            <div class=\"form-group row mt-10\">\n                                <label for=\"\" class=\"label\"\n                                    >รูปภาพเพิ่มเติม :\n                                </label>\n\n                                <div>\n                                    <client-only>\n                                        <dashboard\n                                            :uppy=\"uppy\"\n                                            ref=\"dash\"\n                                            style=\"width: 100%\"\n                                            :props=\"{\n                                                doneButtonHandler: null,\n                                                hideCancelButton: true,\n                                                showRemoveButtonAfterComplete: true,\n                                            }\"\n                                        />\n                                    </client-only>\n                                </div>\n                            </div>\n\n                            <div class=\"form-group row mt-10\">\n                                <label for=\"\" class=\"label label-required\"\n                                    >สถานะ :\n                                </label>\n                                <div>\n                                    <client-only>\n                                        <v-select\n                                            label=\"name_th\"\n                                            placeholder=\"การเผยแพร่\"\n                                            :options=\"selectOptions.publishes\"\n                                            id=\"slt-is_publish\"\n                                            v-model=\"item.is_publish\"\n                                            class=\"v-select-no-border\"\n                                            :clearable=\"true\"\n                                        ></v-select>\n                                    </client-only>\n                                </div>\n                            </div>\n\n                            <!-- btn save -->\n                            <div class=\"col-md-12 mt-20\">\n                                <div class=\"contact__btn-2 text-center\">\n                                    <button\n                                        class=\"btn btn-primary\"\n                                        @click=\"onSubmit\"\n                                    >\n                                        บันทึก\n                                    </button>\n                                </div>\n                            </div>\n                            <!--  -->\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </section>\n</template>\n\n<script setup>\nimport dayjs from \"dayjs\";\nimport \"dayjs/locale/th\";\nimport vSelect from \"vue-select\";\nimport \"vue-select/dist/vue-select.css\";\nimport Swal from \"sweetalert2\";\nimport Toastify from \"toastify-js\";\nimport \"toastify-js/src/toastify.css\";\nimport { useRuntimeConfig } from \"#app\";\nimport froala_data from \"~~/mixins/froalaData\";\nimport basic_data from \"~~/mixins/basicData\";\nimport VueDatePicker from \"@vuepic/vue-datepicker\";\nimport \"@vuepic/vue-datepicker/dist/main.css\";\nimport Uppy from \"@uppy/core\";\nimport { Dashboard } from \"@uppy/vue\";\nimport \"@uppy/core/dist/style.css\";\nimport \"@uppy/dashboard/dist/style.css\";\nimport XHRUpload from \"@uppy/xhr-upload\";\n\nimport buddhistEra from \"dayjs/plugin/buddhistEra\";\ndayjs.extend(buddhistEra);\n\n// Variable\nconst configR = useRuntimeConfig();\nconst { apiBase } = configR.public;\nconst route = useRoute();\nconst router = useRouter();\n\nconst item = ref({\n    id: null,\n    title_th: null,\n    title_en: null,\n    detail_th: \"\",\n    detail_en: \"\",\n    news_type_id: null,\n    is_publish: {},\n});\nconst file = ref(null);\n\nconst selectOptions = ref({\n    publishes: basic_data.data().publishes,\n    news_types: [],\n    departments: [],\n    service_categories: [],\n});\n\nconst format = (date) => {\n    const day = dayjs(date).locale(\"th\").format(\"DD\");\n    const month = dayjs(date).locale(\"th\").format(\"MMM\");\n    const year = date.getFullYear() + 543;\n\n    return `${day} ${month} ${year}`;\n};\n\nconst r = (Math.random() + 1).toString(36).substring(7);\n\nconst uppy = new Uppy({\n    meta: {\n        news_id: route.params.id,\n        secret_key: r,\n        news_gallery_id: null,\n        table_name: \"news\",\n    },\n    debug: true,\n    restrictions: {\n        allowedFileTypes: [\"image/*\", \"video/*\"],\n    },\n}).use(XHRUpload, {\n    endpoint: `${apiBase}/froala/uppy`,\n    fieldName: \"file\",\n});\n\nuppy.on(\"upload-success\", (file, response) => {\n    uppy.setFileMeta(file.id, {\n        url: response.body.link,\n        news_id: response.body.news_id,\n        news_gallery_id: response.body.news_gallery_id,\n    });\n});\n\nuppy.on(\"file-removed\", (file, reason) => {\n    if (file.meta.news_gallery_id != null) {\n        $fetch(`${apiBase}/news-gallery/${file.meta.news_gallery_id}`, {\n            method: \"DELETE\",\n        })\n            .then((res) => {\n                if (res.msg == \"success\") {\n                    console.log(\"success\");\n                } else {\n                    console.log(\"error\");\n                }\n            })\n            .catch((error) => error.data);\n    }\n});\n\nlet config = {};\nconst initFroala = () => {\n    config[\"detail_th\"] = froala_data.data().froala_config();\n    config[\"detail_th\"][\"events\"] = {\n        keyup: function (inputEvent) {\n            item.value.detail_th = this.html.get();\n        },\n        click: function (clickEvent) {\n            item.value.detail_th = this.html.get();\n        },\n        \"commands.after\": function (cmd, param1, param2) {\n            item.value.detail_th = this.html.get();\n        },\n        \"paste.after\": function (pasteEvent) {\n            item.value.detail_th = this.html.get();\n        },\n        initialized: function () {\n            this.html.insert(item.value.detail_th);\n        },\n    };\n};\n\n// Function Fetch\nconst fetchNewsTypes = async () => {\n    let data = await $fetch(`${apiBase}/news-type`, {\n        params: {\n            is_publish: 1,\n        },\n    }).catch((error) => error.data);\n\n    selectOptions.value.news_types = data.data.map((e) => {\n        return { title: e.name_th, value: e.id };\n    });\n};\n\nconst fetchDepartments = async () => {\n    let data = await $fetch(`${apiBase}/department`, {\n        params: {\n            is_publish: 1,\n        },\n    }).catch((error) => error.data);\n\n    selectOptions.value.departments = data.data\n        .map((e) => {\n            return { title: e.name_th, value: e.id };\n        })\n        .filter((x) => {\n            if (\n                useCookie(\"user\").value &&\n                useCookie(\"user\").value.group_id == 2\n            ) {\n                if (x.value == useCookie(\"user\").value.department_id) {\n                    return true;\n                } else {\n                    return false;\n                }\n            }\n\n            return true;\n        });\n};\n\nconst fetchServiceCategories = async () => {\n    let data = await $fetch(`${apiBase}/service-category`, {\n        params: {\n            is_publish: 1,\n        },\n    }).catch((error) => error.data);\n\n    selectOptions.value.service_categories = data.data.map((e) => {\n        return { title: e.name_th, value: e.id };\n    });\n};\n\nconst { data: res } = await useFetch(`${apiBase}/news/${route.params.id}`, {\n    server: true,\n});\n\nitem.value = { ...res.value.data };\nitem.value.news_file_old = res.value.data.news_file;\nitem.value.news_file = null;\n\nitem.value.news_type_id = {\n    title: res.value.data.news_type.name,\n    value: res.value.data.news_type_id,\n};\n\nitem.value.department_id = {\n    value: res.value.data.department_id,\n    title: res.value.data.department.name_th,\n};\n\nlet test = res.value.data.service_categories.map((x) => {\n    return { value: x.service_category.id, title: x.service_category.name_th };\n});\nitem.value.service_category_id = test;\n\ninitFroala();\n\nconst fetchGallery = async () => {\n    await $fetch(`${apiBase}/news-gallery`, {\n        params: {\n            is_publish: 1,\n            news_id: route.params.id,\n        },\n    })\n        .then(async (res) => {\n            let gallery = res.data;\n\n            for (let i = 0; i < gallery.length; i++) {\n                await fetch(gallery[i].news_gallery_file)\n                    .then((response) => response.blob())\n                    .then((blob) => {\n                        uppy.addFile({\n                            name: null,\n                            type: blob.type,\n                            data: blob,\n                            meta: {\n                                relativePath: gallery[i].news_gallery_file,\n                                news_id: gallery[i].news_id,\n                                news_gallery_id: gallery[i].id,\n                                secret_key: gallery[i].secret_key,\n                                isRemote: true,\n                            },\n                            source: \"Local\",\n                            isRemote: false,\n                        });\n                    });\n            }\n            //\n\n            //\n            uppy.getFiles().forEach((file) => {\n                uppy.setFileState(file.id, {\n                    progress: { uploadComplete: true, uploadStarted: true },\n                });\n            });\n        })\n        .catch((error) => error.data);\n};\n\n// Event\nconst onSubmit = async () => {\n    if (\n        item.value.is_publish == null ||\n        item.value.is_publish.value == null ||\n        item.value.news_type_id == null ||\n        item.value.news_type_id.value == null ||\n        item.value.department_id == null ||\n        item.value.department_id.value == null ||\n        item.value.title_th == \"\" ||\n        item.value.title_th == null ||\n        item.value.detail_th == \"\" ||\n        item.value.detail_th == null\n    ) {\n        useToast(\"โปรดระบุข้อมูลให้ครบถ้วน\", \"error\");\n        return;\n    }\n\n    let type_object = {\n        text_success: \"แก้ไขรายการเสร็จสิ้น\",\n        method: \"put\",\n        url: apiBase + \"/news/\" + item.value.id,\n    };\n\n    let service_category_id_arr = [];\n    if (item.value.service_category_id.length != 0) {\n        item.value.service_category_id.forEach((el) => {\n            service_category_id_arr.push(el.value);\n        });\n    }\n\n    let data = {\n        ...item.value,\n        news_file: file.value.files != null ? file.value.files[0] : null,\n        news_type_id:\n            item.value.news_type_id == null\n                ? undefined\n                : item.value.news_type_id.value,\n        department_id:\n            item.value.department_id == null\n                ? undefined\n                : item.value.department_id.value,\n        service_category_id:\n            item.value.service_category_id == null\n                ? undefined\n                : service_category_id_arr,\n        created_news: dayjs().format(\"YYYY-MM-DD\"),\n        is_publish: item.value.is_publish.value,\n    };\n\n    var form_data = new FormData();\n    for (var key in data) {\n        form_data.append(key, data[key]);\n    }\n\n    await $fetch(type_object.url, {\n        method: type_object.method,\n        body: form_data,\n    })\n        .then((res) => {\n            if (res.msg == \"success\") {\n                useToast(type_object.text_success, \"success\");\n                router.push({ path: \"/admin/news/\" + res.id });\n            } else {\n                throw new Error(\"ERROR\");\n            }\n        })\n        .catch((error) => error.data);\n};\n\nonMounted(async () => {\n    await fetchNewsTypes();\n    await fetchDepartments();\n    await fetchServiceCategories();\n    await fetchGallery();\n\n    item.value.is_publish = selectOptions.value.publishes.find((x) => {\n        return Number(res.value.data.is_publish) == x.value;\n    });\n});\n</script>\n"],"names":["res","_withAsyncContext"],"mappings":"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"}
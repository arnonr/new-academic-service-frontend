import{f as v,g as Y,s as j,h as L,i as g,t as O,j as z,c as A,b as e,e as r,w as d,l as s,k as H,v as X,F as G,m as I,y as V,p as J,r as P,o as K,q as $,C as f,D as k}from"./OmrnE3d5.js";import{_ as Q}from"./B-r68-ay.js";import{u as W}from"./D-HlV6Uy.js";import{u as C}from"./I6A_oj8C.js";import{b as Z}from"./BKZYPkvF.js";import{f as ee}from"./C0vxPmJo.js";import{U as te,X as le,a as ae,D as se}from"./VsOuaCTX.js";const oe={class:"breadcrumb__area include-bg pb-40 pt-30 grey-bg-4"},ie={class:"container"},ne={class:"row"},re={class:"col-xxl-12"},de={class:"breadcrumb__content p-relative z-index-1"},ue={class:"breadcrumb__list"},ce=e("span",null," จัดการข้อมูล ",-1),_e=e("span",{class:"dvdr"},[e("i",{class:"fa-solid fa-circle-small"})],-1),pe=e("span",{class:"dvdr"},[e("i",{class:"fa-solid fa-circle-small"})],-1),me=e("span",null," แก้ไขข้อมูล ",-1),he={class:"portfolio__area pt-40 pb-40"},ve={class:"container"},fe={class:"row"},be=e("div",{class:"col-12"},[e("h4",null,"แบบฟอร์มแก้ไขข้อมูลข่าว")],-1),ye={class:"col-12"},we={class:""},ge={class:""},Ve={class:"form-group row mt-10"},$e=e("label",{for:"",class:"label label-required"},"หน่วยงาน : ",-1),xe={class:"form-group row mt-10"},ke=e("label",{for:"",class:"label label-required"},"ประเภทข่าว : ",-1),Ce={class:"form-group row mt-10"},Fe=e("label",{for:"",class:"label label-required"},"ประเภทการบริการวิชาการ : ",-1),De={class:"form-group row mt-10"},Ee=e("label",{for:"",class:"label label-required"},"รูปภาพปก : ",-1),Re={class:"col-sm-10"},Ue={class:"col-sm-2"},Me=["href"],qe={class:"form-group row mt-10"},Be=e("label",{for:"",class:"label label-required"},"หัวข้อ : ",-1),Ne={class:"form-group row mt-10"},Se=e("label",{for:"",class:"label label-required"},"เนื้อหาข่าว : ",-1),Te=e("div",{id:"detail-th"},null,-1),Ye={class:"form-group row mt-10"},je=e("label",{for:"",class:"label label-required"},"วันที่ลงข้อมูล : ",-1),Le={class:"form-group row mt-10"},Oe=e("label",{for:"",class:"label"},"รูปภาพเพิ่มเติม : ",-1),ze={class:"form-group row mt-10"},Ae=e("label",{for:"",class:"label label-required"},"สถานะ : ",-1),We={__name:"[id]",async setup(He){let m,x;v.extend(Y);const F=I(),{apiBase:u}=F.public,b=j(),D=L(),l=g({id:null,title_th:null,title_en:null,detail_th:"",detail_en:"",news_type_id:null,is_publish:{}}),y=g(null),c=g({publishes:Z.data().publishes,news_types:[],departments:[],service_categories:[]}),E=a=>{const t=v(a).locale("th").format("DD"),i=v(a).locale("th").format("MMM"),n=a.getFullYear()+543;return`${t} ${i} ${n}`},R=(Math.random()+1).toString(36).substring(7),p=new te({meta:{news_id:b.params.id,secret_key:R,news_gallery_id:null,table_name:"news"},debug:!0,restrictions:{allowedFileTypes:["image/*","video/*"]}}).use(le,{endpoint:`${u}/froala/uppy`,fieldName:"file"});p.on("upload-success",(a,t)=>{p.setFileMeta(a.id,{url:t.body.link,news_id:t.body.news_id,news_gallery_id:t.body.news_gallery_id})}),p.on("file-removed",(a,t)=>{a.meta.news_gallery_id!=null&&$fetch(`${u}/news-gallery/${a.meta.news_gallery_id}`,{method:"DELETE"}).then(i=>{i.msg=="success"?console.log("success"):console.log("error")}).catch(i=>i.data)});let w={};const U=()=>{w.detail_th=ee.data().froala_config(),w.detail_th.events={keyup:function(a){l.value.detail_th=this.html.get()},click:function(a){l.value.detail_th=this.html.get()},"commands.after":function(a,t,i){l.value.detail_th=this.html.get()},"paste.after":function(a){l.value.detail_th=this.html.get()},initialized:function(){this.html.insert(l.value.detail_th)}}},M=async()=>{let a=await $fetch(`${u}/news-type`,{params:{is_publish:1}}).catch(t=>t.data);c.value.news_types=a.data.map(t=>({title:t.name_th,value:t.id}))},q=async()=>{let a=await $fetch(`${u}/department`,{params:{is_publish:1}}).catch(t=>t.data);c.value.departments=a.data.map(t=>({title:t.name_th,value:t.id})).filter(t=>V("user").value&&V("user").value.group_id==2?t.value==V("user").value.department_id:!0)},B=async()=>{let a=await $fetch(`${u}/service-category`,{params:{is_publish:1}}).catch(t=>t.data);c.value.service_categories=a.data.map(t=>({title:t.name_th,value:t.id}))},{data:_}=([m,x]=O(()=>W(`${u}/news/${b.params.id}`,{server:!0},"$fJ9nbSCi0M")),m=await m,x(),m);l.value={..._.value.data},l.value.news_file_old=_.value.data.news_file,l.value.news_file=null,l.value.news_type_id={title:_.value.data.news_type.name,value:_.value.data.news_type_id},l.value.department_id={value:_.value.data.department_id,title:_.value.data.department.name_th};let N=_.value.data.service_categories.map(a=>({value:a.service_category.id,title:a.service_category.name_th}));l.value.service_category_id=N,U();const S=async()=>{await $fetch(`${u}/news-gallery`,{params:{is_publish:1,news_id:b.params.id}}).then(async a=>{let t=a.data;for(let i=0;i<t.length;i++)await fetch(t[i].news_gallery_file).then(n=>n.blob()).then(n=>{p.addFile({name:null,type:n.type,data:n,meta:{relativePath:t[i].news_gallery_file,news_id:t[i].news_id,news_gallery_id:t[i].id,secret_key:t[i].secret_key,isRemote:!0},source:"Local",isRemote:!1})});p.getFiles().forEach(i=>{p.setFileState(i.id,{progress:{uploadComplete:!0,uploadStarted:!0}})})}).catch(a=>a.data)},T=async()=>{if(l.value.is_publish==null||l.value.is_publish.value==null||l.value.news_type_id==null||l.value.news_type_id.value==null||l.value.department_id==null||l.value.department_id.value==null||l.value.title_th==""||l.value.title_th==null||l.value.detail_th==""||l.value.detail_th==null){C("โปรดระบุข้อมูลให้ครบถ้วน","error");return}let a={text_success:"แก้ไขรายการเสร็จสิ้น",method:"put",url:u+"/news/"+l.value.id},t=[];l.value.service_category_id.length!=0&&l.value.service_category_id.forEach(o=>{t.push(o.value)});let i={...l.value,news_file:y.value.files!=null?y.value.files[0]:null,news_type_id:l.value.news_type_id==null?void 0:l.value.news_type_id.value,department_id:l.value.department_id==null?void 0:l.value.department_id.value,service_category_id:l.value.service_category_id==null?void 0:t,created_news:v().format("YYYY-MM-DD"),is_publish:l.value.is_publish.value};var n=new FormData;for(var h in i)n.append(h,i[h]);await $fetch(a.url,{method:a.method,body:n}).then(o=>{if(o.msg=="success")C(a.text_success,"success"),D.push({path:"/admin/news/"+o.id});else throw new Error("ERROR")}).catch(o=>o.data)};return z(async()=>{await M(),await q(),await B(),await S(),l.value.is_publish=c.value.publishes.find(a=>Number(_.value.data.is_publish)==a.value)}),(a,t)=>{const i=J,n=Q,h=P("froala");return K(),A(G,null,[e("section",oe,[e("div",ie,[e("div",ne,[e("div",re,[e("div",de,[e("div",ue,[ce,_e,e("span",null,[r(i,{href:"/admin/news"},{default:d(()=>[$(" รายการข่าว ")]),_:1})]),pe,me])])])])])]),e("section",he,[e("div",ve,[e("div",fe,[be,e("div",ye,[e("div",we,[e("div",ge,[e("div",Ve,[$e,e("div",null,[r(n,null,{default:d(()=>[r(s(f),{label:"title",placeholder:"หน่วยงาน",options:s(c).departments,modelValue:s(l).department_id,"onUpdate:modelValue":t[0]||(t[0]=o=>s(l).department_id=o),class:"v-select-no-border",clearable:!0},null,8,["options","modelValue"])]),_:1})])]),e("div",xe,[ke,e("div",null,[r(n,null,{default:d(()=>[r(s(f),{label:"title",placeholder:"ประเภทข่าว",options:s(c).news_types,modelValue:s(l).news_type_id,"onUpdate:modelValue":t[1]||(t[1]=o=>s(l).news_type_id=o),class:"v-select-no-border",clearable:!0},null,8,["options","modelValue"])]),_:1})])]),e("div",Ce,[Fe,e("div",null,[r(n,null,{default:d(()=>[r(s(f),{label:"title",placeholder:"ประเภทการบริการวิชาการ",options:s(c).service_categories,modelValue:s(l).service_category_id,"onUpdate:modelValue":t[2]||(t[2]=o=>s(l).service_category_id=o),multiple:"",class:"v-select-no-border",clearable:!0},null,8,["options","modelValue"])]),_:1})])]),e("div",De,[Ee,e("div",Re,[e("input",{ref_key:"file",ref:y,class:"form-control",type:"file",id:"formFile"},null,512)]),e("div",Ue,[e("a",{href:s(l).news_file_old,target:"_blank",class:"btn btn-primary",style:{width:"100%"}}," View Old File ",8,Me)])]),e("div",qe,[Be,e("div",null,[H(e("input",{type:"text",class:"form-control form-control-plaintext","onUpdate:modelValue":t[3]||(t[3]=o=>s(l).title_th=o)},null,512),[[X,s(l).title_th]])])]),e("div",Ne,[Se,e("div",null,[r(n,null,{default:d(()=>[r(h,{tag:"textarea",config:s(w).detail_th,modelValue:s(l).detail_th,"onUpdate:modelValue":t[4]||(t[4]=o=>s(l).detail_th=o)},null,8,["config","modelValue"]),Te]),_:1})])]),e("div",Ye,[je,e("div",null,[r(s(ae),{modelValue:s(l).created_news,"onUpdate:modelValue":t[5]||(t[5]=o=>s(l).created_news=o),"enable-time-picker":!1,locale:"th","auto-apply":"",format:E},{"year-overlay-value":d(({text:o})=>[$(k(parseInt(o)+543),1)]),year:d(({year:o})=>[$(k(o+543),1)]),_:1},8,["modelValue"])])]),e("div",Le,[Oe,e("div",null,[r(n,null,{default:d(()=>[r(s(se),{uppy:s(p),ref:"dash",style:{width:"100%"},props:{doneButtonHandler:null,hideCancelButton:!0,showRemoveButtonAfterComplete:!0}},null,8,["uppy"])]),_:1})])]),e("div",ze,[Ae,e("div",null,[r(n,null,{default:d(()=>[r(s(f),{label:"name_th",placeholder:"การเผยแพร่",options:s(c).publishes,id:"slt-is_publish",modelValue:s(l).is_publish,"onUpdate:modelValue":t[6]||(t[6]=o=>s(l).is_publish=o),class:"v-select-no-border",clearable:!0},null,8,["options","modelValue"])]),_:1})])]),e("div",{class:"col-md-12 mt-20"},[e("div",{class:"contact__btn-2 text-center"},[e("button",{class:"btn btn-primary",onClick:T}," บันทึก ")])])])])])])])])],64)}}};export{We as default};
